{% extends "base.html" %}

{% block content %}
    <h1>Add Item to Order</h1>
    <form method="POST" id="add-item-form">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.product_name.label }}
            {{ form.product_name(class="form-control", id="product-search") }}
            <div id="search-results"></div>
        </div>
        <div class="form-group">
            {{ form.quantity.label }}
            {{ form.quantity(class="form-control") }}
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>

    <hr>

    <h2>Current Order Items</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order.items %}
                <tr>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>${{ "%.2f"|format(item.product.price) }}</td>
                    <td>${{ "%.2f"|format(item.product.price * item.quantity) }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p><strong>Total Order Amount: ${{ "%.2f"|format(order.total_amount) }}</strong></p>
    
    <a href="{{ url_for('main.view_customer_order', order_id=order.id) }}" class="btn btn-success">Finish Order</a>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#product-search').on('input', function() {
        var query = $(this).val();
        if (query.length > 2) {
            $.get('/search_products?query=' + query, function(data) {
                var results = $('#search-results');
                results.empty();
                data.forEach(function(product) {
                    results.append('<div class="search-result" data-id="' + product.id + '">' + product.name + ' - $' + product.price.toFixed(2) + '</div>');
                });
            });
        } else {
            $('#search-results').empty();
        }
    });

    $(document).on('click', '.search-result', function() {
        $('#product-search').val($(this).text().split(' - ')[0]);
        $('#search-results').empty();
    });
});
</script>
{% endblock %}